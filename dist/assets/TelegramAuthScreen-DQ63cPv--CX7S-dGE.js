import{dA as H,d5 as z,d6 as B,d7 as Q,d9 as T,dq as X,dw as S,d4 as U,ez as O,dr as Y,db as m,dJ as G}from"./index-BZUZJG0z.js";import{a as K}from"./shouldProceedtoEmbeddedWalletCreationFlow-D0uaMzCB-ChwW2HLS.js";import{n as Z}from"./ScreenLayout-DIdy7nhJ-CtKEKsly.js";import{c as $}from"./telegram-B-JqnkqZ-DQ1cS9We.js";import"./ModalHeader-D5psNgrf-BlEKM6aB.js";import"./Screen-q8npRQhQ-DadJ2eBF.js";import"./index-Dq_xe9dz-CmgW7sSb.js";const ee=({success:r,errorMessage:t,onRetry:u})=>{let n=r?"Successfully connected with Telegram":t?t.message:"Verifying connection to Telegram";return U.jsx(Z,{title:n,subtitle:r?"You're good to go!":t?t.detail:"Just a few moments more",icon:$,iconVariant:"loading",iconLoadingStatus:{success:r,fail:!!t},secondaryCta:t!=null&&t.retryable&&u?{label:"Retry",onClick:u}:void 0,watermark:!0})},ne={component:()=>{let{authenticated:r,logout:t,ready:u,user:n}=H(),{setModalData:E,navigate:d,resetNavigation:g,data:c}=z(),f=B(),{initLoginWithTelegram:k,loginWithTelegram:I,updateWallets:F,setReadyToTrue:q,closePrivyModal:J,createAnalyticsEvent:P,getAuthMeta:R}=Q(),[v,V]=T.useState(!1),[A,o]=T.useState(void 0),s=X();async function b(){var i,a,l,y,h,C,w,_,W,L,M,D,N,x;try{let e=await(async function(){let p;if(!r){if(s.enabled&&s.status==="error")throw new Y(s.error,null,m.CAPTCHA_FAILURE);return s.enabled&&s.status!=="success"&&(s.execute(),p=await s.waitForResult()),p}})();await I({captchaToken:e}),V(!0),q(!0)}catch(e){if((e==null?void 0:e.privyErrorCode)===m.ALLOWLIST_REJECTED)return o(void 0),g(),void d("AllowlistRejectionScreen");if((e==null?void 0:e.privyErrorCode)===m.USER_LIMIT_REACHED)return console.error(new G(e).toString()),o(void 0),g(),void d("UserLimitReachedScreen");if((e==null?void 0:e.privyErrorCode)===m.USER_DOES_NOT_EXIST)return o(void 0),g(),void d("AccountNotFoundScreen");if((e==null?void 0:e.privyErrorCode)===m.ACCOUNT_TRANSFER_REQUIRED&&((a=(i=e.data)==null?void 0:i.data)!=null&&a.nonce))return o(void 0),g(),E({accountTransfer:{nonce:(y=(l=e.data)==null?void 0:l.data)==null?void 0:y.nonce,account:(C=(h=e.data)==null?void 0:h.data)==null?void 0:C.subject,telegramAuthResult:(w=R())==null?void 0:w.telegramAuthResult,telegramWebAppData:(_=R())==null?void 0:_.telegramWebAppData,displayName:(M=(L=(W=e.data)==null?void 0:W.data)==null?void 0:L.account)==null?void 0:M.displayName,linkMethod:"telegram",embeddedWalletAddress:(x=(N=(D=e.data)==null?void 0:D.data)==null?void 0:N.otherUser)==null?void 0:x.embeddedWalletAddress}}),void d("LinkConflictScreen");let{retryable:p,detail:j}=O(e);o({retryable:p,detail:j,message:"Authentication failed"})}}return T.useEffect((()=>{b()}),[]),T.useEffect((()=>{if(!(u&&r&&v&&n))return;if(f!=null&&f.legal.requireUsersAcceptTerms&&!n.hasAcceptedTerms){let a=setTimeout((()=>{d("AffirmativeConsentScreen")}),S);return()=>clearTimeout(a)}if(K(n,f.embeddedWallets)){let a=setTimeout((()=>{E({createWallet:{onSuccess:()=>{},onFailure:l=>{console.error(l),P({eventName:"embedded_wallet_creation_failure_logout",payload:{error:l,provider:"telegram",screen:"TelegramAuthScreen"}}),t()},callAuthOnSuccessOnClose:!0}}),d("EmbeddedWalletOnAccountCreateScreen")}),S);return()=>clearTimeout(a)}F();let i=setTimeout((()=>J({shouldCallAuthOnSuccess:!0,isSuccess:!0})),S);return()=>clearTimeout(i)}),[u,r,v,n]),U.jsx(ee,{success:v,errorMessage:A,onRetry:A!=null&&A.retryable?async()=>{var i,a;try{o(void 0),(i=c==null?void 0:c.telegramAuthModalData)!=null&&i.seamlessAuth||await k(void 0,(a=c==null?void 0:c.login)==null?void 0:a.disableSignup),await b()}catch(l){let{retryable:y,detail:h}=O(l);o({retryable:y,detail:h,message:"Authentication failed"})}}:void 0})},isCaptchaRequired:!0,isShownBeforeReady:!0};export{ne as TelegramAuthScreen,ee as TelegramAuthScreenView,ne as default};
