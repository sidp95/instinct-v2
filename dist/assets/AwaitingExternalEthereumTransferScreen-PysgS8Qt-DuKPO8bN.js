import{d7 as Je,d5 as Ve,d6 as Xe,dc as Ye,d9 as r,dd as Ke,n as Ze,o as ze,m as le,r as ue,dh as me,bC as Ge,df as S,dg as F,db as E,dj as fe,d3 as M,di as ke,d4 as d}from"./index-BZUZJG0z.js";import{F as et}from"./CheckCircleIcon-D6_brTOf.js";import{c as tt,n as at,s as nt}from"./Layouts-BlFm53ED-D8gWrHLU.js";import{b as he}from"./ModalHeader-D5psNgrf-BlEKM6aB.js";import{o as it}from"./ScreenHeader-CHmc4-Lu-D968ig42.js";import{t as pe}from"./FundWalletMethodHeader-CI5afzwL-BZtXSULE.js";import{t as rt}from"./index-Dq_xe9dz-CmgW7sSb.js";import{c as st,t as ot}from"./useGetTokenPrice-C1-pGMgN-DqVN8PHa.js";import{t as ge}from"./transfer-CMPmjPsM-Cjofo3yZ.js";import{t as dt}from"./formatErc20TokenAmount-BuPk9xcy-CkAr4Oc0.js";import{n as ct,o as ve,c as J,l as lt}from"./ethers-TpFbevgv-CT39HWSi.js";import{t as ye}from"./analytics-mkkvFRju-DOXuftJB.js";import{o as V,u as Ce,d as Ie,f as ut}from"./reservoir-kvLjIrEo-Do6elMp6.js";import{H as mt,X as ft}from"./BridgeNetworkSelectionView-T2-4Tr4k-dbSshkjR.js";import{n as ht}from"./getErc20Balance-CaKjNAs9-UsIHWji5.js";import{I as pt}from"./TransferOrBridgeLoadingScreen-BZTN__SI-D57ZmH6x.js";import{p as gt}from"./parseEther-CIE0GjS_.js";import{c as vt}from"./custom-GteR2eih.js";import"./useGetSolPrice-Cfm8o9C5-DeeG65FR.js";import"./Value-tcJV9e0L-Dbu4EDrR.js";import"./LoadingSkeleton-U6-3yFwI-BqvAdjZO.js";import"./ErrorMessage-D8VaAP5m-C-TFvMaa.js";import"./Subtitle-CV-2yKE4-D-H5V56C.js";import"./Title-BnzYV3Is-BkAZi-Pa.js";import"./WalletIcon-hh3-YJ30.js";import"./getChainName-DjpPdUSc-c2urPd0g.js";import"./Chip-D2-wZOHJ-DUiT6Tro.js";import"./shared-FM0rljBt-CEF3ZWm_.js";import"./ChevronDownIcon-k3TGnLFx.js";import"./styles-CaJCyFB5-BHZKprYK.js";import"./LinkPasskeyScreen-DJveInKu-fpSMIaSF.js";import"./TodoList-CgrU7uwu-C9JMyp_T.js";import"./createLucideIcon-B72mi0g_.js";import"./check-BDT86Nu8.js";import"./ScreenLayout-DIdy7nhJ-CtKEKsly.js";import"./Screen-q8npRQhQ-DadJ2eBF.js";import"./circle-check-big-CartQiBB.js";import"./fingerprint-pattern-DCdiYDPD.js";import"./formatters-BCBPo00w.js";import"./InjectedWalletIcon-DLcYOGDj-DBB2QKeI.js";import"./Address-BGlhcEcA-BeY89XEP.js";import"./copy-PrcWgVQF.js";import"./GlobeAltIcon-COUUlDl-.js";import"./parseUnits-COoaZUsJ.js";const da={component:()=>{var ne,ie,re,se,oe;let{rpcConfig:j,appId:C,closePrivyModal:Te,createAnalyticsEvent:X}=Je(),{navigate:be,setModalData:W,data:a}=Ve(),Y=Xe(),{wallets:we}=Ye(),[Se,Ee]=r.useState(!1),[I,xe]=r.useState(0n),[K,Z]=r.useState(!1),[q,v]=r.useState(null),[Ne,_]=r.useState(null),[T,Ae]=r.useState([]),[z,Fe]=r.useState(0),[G,x]=r.useState(!1),[D,$]=r.useState(!1),[k,L]=r.useState(!1),[R,ee]=r.useState(!1),[je,$e]=r.useState(),[Be,te]=r.useState();if(!(a!=null&&a.funding)||a.funding.chainType!=="ethereum")throw Error("Invalid funding data");let{erc20ContractInfo:t,chain:i,connectedWallet:B}=a.funding,h=a.funding.address,m=a.funding.erc20Address,[b,Ue]=r.useState(a.funding.amount);r.useEffect((()=>{m&&!t&&v(Error("Unable to fetch token details"))}),[]);let c=!!m&&!!t,f=c?BigInt(parseFloat(b)*10**t.decimals):gt(b),e=((B==null?void 0:B.type)==="ethereum"?B:void 0)??we[0],Q=Ke((e==null?void 0:e.walletClientType)||"unknown"),ae=(Q==null?void 0:Q.name)||"wallet",[y,Pe]=r.useState(null);r.useEffect((()=>{(async()=>{if(!e)return;let s=await e.getEthereumProvider();Pe(Ze({account:e.address,transport:vt(s)}).extend(ze))})().catch(console.error)}),[e]);let[He,Me]=r.useState(0n);r.useEffect((()=>{le({chain:i,transport:ue(me(i,j,C))}).getBalance({address:h}).then(Me).catch(console.error)}),[]);let[We,qe]=r.useState(0n);r.useEffect((()=>{c&&ht({chain:i,address:h,appId:C,rpcConfig:j,erc20Address:m}).then((s=>qe(s.balance))).catch(console.error)}),[]);let{tokenPrice:w}=st(i.id),[o,U]=r.useState({to:h,chain:i,value:f,data:void 0});r.useEffect((()=>{(async()=>{let s,l;if(!y||!e||G||k)return;x(!0);let p=le({chain:o.chain,transport:ue(me(o.chain,j,C))});if(c&&!o.data)return await p.simulateContract({address:m,chain:o.chain,abi:ge,functionName:"transfer",args:[h,f],account:e.address}).catch((u=>{console.warn("Simulated token transfer failed with error, fetching bridge options.",u)}))?(x(!1),void U({to:m,chain:o.chain,data:Ge({abi:ge,functionName:"transfer",args:[h,f]}),value:"0x0"})):(x(!1),void Z(!0));try{s=await p.prepareTransactionRequest({account:e.address,to:o.to,chain:o.chain,data:o.data,value:BigInt(o.value??0)})}catch(u){if(console.error(u),T.length>1)_(u.shortMessage??"Something went wrong");else if(D&&T.length===0)return void v(new S(`Wallet ${F(e.address)} does not have enough funds.`,void 0,E.INSUFFICIENT_BALANCE))}if(!s)return x(!1),void Z(!0);x(!1),L(!0),Ee(!0),xe(s.gas);try{await y.switchChain({id:o.chain.id})}catch{await y.addChain({chain:o.chain}),await y.switchChain({id:o.chain.id})}try{l=await y.sendTransaction(s)}catch(u){if(console.error(u),u.name==="TransactionExecutionError")if(T.length<1){let H=u.shortMessage;(u.shortMessage.includes("rejected the request")||u.details.includes("rejected the request"))&&(H="User rejected the request."),v(new S(H,void 0,E.TRANSACTION_FAILURE))}else _(u.shortMessage??"Something went wrong")}if(l)return await y.waitForTransactionReceipt({hash:l}),L(!1),D?($e(l),void te("pending")):(ee(!0),W(fe(a,"completed",l,e==null?void 0:e.walletClientType,c,t,i)),void X({eventName:ye,payload:{provider:"external",status:"success",txHash:l,address:e.address,chainId:o.chain.id,chainType:"ethereum",value:o.value?M(BigInt(o.value),(t==null?void 0:t.decimals)??18):void 0,token:(t==null?void 0:t.symbol)??m??"ETH",destinationAddress:h,destinationChainId:i.id,destinationChainType:"ethereum",destinationValue:f?M(f,(t==null?void 0:t.decimals)??18):void 0,destinationToken:(t==null?void 0:t.symbol)??m??i.nativeCurrency.name}}));L(!1)})().catch(console.error)}),[y,o]),r.useEffect((()=>{(async()=>{var ce;if(!K||!y||!e)return;let s=ot(Y.chains).filter((n=>n.id!==i.id&&!!n.testnet==!!i.testnet));c&&s.unshift(i);let l=await mt({chains:s,address:e.address,appId:C,rpcConfig:j,includeUsdc:(ce=a.funding)==null?void 0:ce.isUSDC}),p=c?l.filter((n=>n.balance>0n)):l.filter((n=>n.balance>f)),u=c&&l.every((n=>n.balance===0n));if(p.length<1)return void v(new S(u?`Wallet ${F(e.address)} doesn't have enough funds to cover gas fees. Top up your wallet and try again.`:`Wallet ${F(e.address)} does not have enough funds.`,void 0,E.INSUFFICIENT_BALANCE));p.sort(((n,A)=>Number(c?(A.erc20Balance??0n)-(n.erc20Balance??0n):A.balance-n.balance)));let H=p.flatMap((n=>{let A=[{...n,isErc20Quote:!1,isTestnet:!!i.testnet,input:V({appId:C,amount:f.toString(),user:e.address,recipient:h,destinationChainId:i.id,destinationCurrency:m,originChainId:n.chain.id})}];return c&&m&&(n.erc20Balance??0n)>=f&&A.push({...n,isErc20Quote:!0,isTestnet:!!i.testnet,input:V({appId:C,amount:f.toString(),user:e.address,recipient:h,destinationChainId:i.id,destinationCurrency:m,originChainId:n.chain.id,originCurrency:n.erc20Address})}),A})),de=(await Promise.allSettled(H.map((async n=>({...n,quote:await Ce(n)}))))).filter((n=>n.status==="fulfilled")).map((n=>n.value));if(de.length<1)return void v(new S(`Wallet ${F(e.address)} does not have enough funds.`,void 0,E.INSUFFICIENT_BALANCE));let O=de.map((n=>({bridgeTx:Ie(n.quote),balance:n.balance,chain:n.chain,erc20Balance:n.erc20Balance,isErc20Quote:n.isErc20Quote}))).filter((n=>!!n.bridgeTx));if(O.length>1)return void Ae(O);let N=O[0];N?($(!0),U({data:N.bridgeTx.data,to:N.bridgeTx.to,value:N.bridgeTx.value,chain:N.chain})):v(new S(`Wallet ${F(e.address)} does not have enough funds.`,void 0,E.INSUFFICIENT_BALANCE))})().catch(console.error)}),[K]),ut({transactionHash:je,isTestnet:!!i.testnet,bridgingStatus:Be,setBridgingStatus:te,onSuccess({transactionHash:s}){$(!1),ee(!0),W(fe(a,"completed",s,e==null?void 0:e.walletClientType,c,t,i)),X({eventName:ye,payload:{provider:"external",status:"success",txHash:s,address:e==null?void 0:e.address,chainId:o.chain.id,chainType:"ethereum",value:o.value?M(BigInt(o.value),(t==null?void 0:t.decimals)??18):void 0,token:(t==null?void 0:t.symbol)??m??"ETH",destinationAddress:h,destinationChainId:i.id,destinationChainType:"ethereum",destinationValue:f?M(f,(t==null?void 0:t.decimals)??18):void 0,destinationToken:(t==null?void 0:t.symbol)??m??i.nativeCurrency.name}})},onFailure({error:s}){$(!1),v(s)}}),r.useEffect((()=>{q&&(W({funding:a==null?void 0:a.funding,solanaFundingData:a==null?void 0:a.solanaFundingData,sendTransaction:a==null?void 0:a.sendTransaction,errorModalData:{error:q,previousScreen:"TransferFromWalletScreen"}}),be("ErrorScreen",!1))}),[q]);let _e=!c&&w?ct(b??"0",w):void 0,P=c?I:lt([I,f]),De=P&&w?ve(P,w):void 0,Le=P?J(P,(ne=a==null?void 0:a.funding)!=null&&ne.erc20Address?((re=(ie=a==null?void 0:a.funding)==null?void 0:ie.erc20ContractInfo)==null?void 0:re.symbol)||"ETH":((se=a==null?void 0:a.funding)==null?void 0:se.chain.nativeCurrency.symbol)||"ETH"):void 0,Re=I&&w?ve(I,w):void 0,Qe=I?J(I,((oe=i==null?void 0:i.nativeCurrency)==null?void 0:oe.symbol)||"ETH"):void 0;if(r.useEffect((()=>{if(!R)return;let s=setTimeout(Te,ke);return()=>clearTimeout(s)}),[R]),R)return d.jsxs(d.Fragment,{children:[d.jsx(pe,{}),d.jsx(tt,{}),d.jsxs(at,{children:[d.jsx(et,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),d.jsx(it,{title:"Success!",description:`Youâ€™ve successfully added ${b} ${c?t.symbol:i.nativeCurrency.symbol} to your ${Y.name} wallet. It may take a minute before the funds are available to use.`})]}),d.jsx(nt,{}),d.jsx(he,{})]});let Oe=c?`${dt({amount:We,decimals:t.decimals})}  ${t.symbol}`:J(He,i.nativeCurrency.symbol,3,!0),g=T[z];return T.length>1&&g?d.jsx(ft,{displayName:ae,configuredFundingChain:i,erc20ContractInfo:t,formattedBalance:Oe,fundingAmount:b,fundingCurrency:c?t.symbol:i.nativeCurrency.symbol,fundingAmountInUsd:_e,options:T,selectedOption:g,isPreparing:G,isSubmitting:k,addressToFund:h,fundingWalletAddress:(e==null?void 0:e.address)||"",errorMessage:Ne,onSubmit:()=>{var s;((s=a.funding)==null?void 0:s.amount)!==b?(async function(){if(e&&g)try{let l=await Ce({isTestnet:!!i.testnet,input:V({appId:C,amount:f.toString(),user:e.address,recipient:h,destinationChainId:i.id,destinationCurrency:m,originChainId:g.chain.id})}),p=Ie(l);if(!p)throw Error("Invalid transaction request");$(!0),U({data:p.data,to:p.to,value:p.value,chain:g.chain})}catch(l){console.error(l),v(new S("Unable to fetch quotes for bridging",l,E.INSUFFICIENT_BALANCE))}})().catch(console.error):U({to:g.bridgeTx.to,data:g.bridgeTx.data,value:g.bridgeTx.value,chain:g.chain})},onSelect:s=>{s!==z&&(_(null),Fe(s))},onAmountChange:Ue}):Se&&I&&e&&(a!=null&&a.funding)?d.jsx(pt,{walletClientType:(e==null?void 0:e.walletClientType)||"unknown",displayName:ae,addressToFund:h,isBridging:D,isErc20Flow:c,totalPriceInUsd:De,totalPriceInNativeCurrency:Le,gasPriceInUsd:Re,gasPriceInNativeCurrency:Qe,chainId:i.id,chainName:i.name}):d.jsxs(d.Fragment,{children:[d.jsx(pe,{}),d.jsx(rt,{}),d.jsx("div",{style:{marginTop:"1rem"}}),d.jsx(he,{})]})}};export{da as AwaitingExternalEthereumTransferScreen,da as default};
