import{dz as v,d9 as i,dA as V,d5 as ze,d6 as Pe,d7 as Xe,dk as Je,dq as Ke,dd as Qe,dy as R,dB as Ve,dC as Ee,dD as $e,dw as _e,dE as $,d4 as y,dx as Ge,dF as Ze,db as k,dG as He,dH as Ye,dI as Te,dJ as et,bX as tt,bI as nt,ds as at}from"./index-BZUZJG0z.js";import{n as Re}from"./Link-DJ5gq9Di-HJKsU0YK.js";import{n as ke}from"./useI18n-CD7HCIxK-CHc5ankF.js";import{a as ot}from"./shouldProceedtoEmbeddedWalletCreationFlow-D0uaMzCB-ChwW2HLS.js";import{n as it}from"./ScreenLayout-DIdy7nhJ-CtKEKsly.js";import"./ModalHeader-D5psNgrf-BlEKM6aB.js";import"./Screen-q8npRQhQ-DadJ2eBF.js";import"./index-Dq_xe9dz-CmgW7sSb.js";const ve=o=>{var E;let s=(E=localStorage.getItem("-walletlink:https://www.walletlink.org:Addresses"))==null?void 0:E.split(" ").filter((l=>tt(l,{strict:!0}))).map((l=>nt(l)));return!!(s!=null&&s.length)&&!!(o!=null&&o.linkedAccounts.filter((l=>l.type=="wallet"&&s.includes(l.address))).length)},lt=o=>(o==null?void 0:o.privyErrorCode)===k.LINKED_TO_ANOTHER_USER?v.ERROR_USER_EXISTS:o instanceof He&&!o.details.default?o.details:o instanceof Ye?v.ERROR_TIMED_OUT:(o==null?void 0:o.privyErrorCode)===k.CANNOT_LINK_MORE_OF_TYPE?v.ERROR_USER_LIMIT_REACHED:v.ERROR_WALLET_CONNECTION,rt=({walletLogo:o,title:s,subtitle:E,signSuccess:l,errorMessage:c,connectSuccess:S,separateConnectAndSign:A,signing:x,walletConnectRedirectUri:N,walletConnectFallbackUniversalUri:u,hasTabbedAway:D,showCoinbaseWalletResetCta:j,numRetries:z,onBack:_,onSign:n,onRetry:T,onCoinbaseReset:I,onDifferentWallet:m})=>{let{t:e}=ke(),P=j?{label:"Use a different wallet",onClick:I,disabled:l}:c===v.ERROR_USER_EXISTS&&_?{label:"Use a different wallet",onClick:m}:S&&!l&&A?{label:x?"Signing":"Sign with your wallet",onClick:n,disabled:x}:!l&&(c!=null&&c.retryable)&&z<2?{label:"Retry",onClick:T,disabled:!1}:l||c?void 0:{label:e("connectionStatus.connecting"),onClick:()=>{},disabled:!0};return y.jsx(it,{title:s,subtitle:E,icon:o,iconVariant:"loading",iconLoadingStatus:{success:l,fail:!!c},primaryCta:P,onBack:_,watermark:!0,children:!S&&N&&!D&&y.jsxs(st,{children:[e("connectionStatus.stillHere")," ",y.jsx(Re,{href:N,target:"_blank",variant:"underlined",size:"sm",children:e("connectionStatus.tryConnectingAgain")}),u&&y.jsxs(y.Fragment,{children:[" ",e("connectionStatus.or")," ",y.jsx(Re,{href:u,target:"_blank",variant:"underlined",size:"sm",children:e("connectionStatus.useDifferentLink")})]})]})})},mt={component:()=>{var ae,oe,ie,le,re,se,ce,de,ue,ge,Se,pe,fe,we,me;let o,[s,E]=i.useState(!1),[l,c]=i.useState(!1),[S,A]=i.useState(void 0),{authenticated:x,logout:N}=V(),{navigate:u,navigateBack:D,lastScreen:j,currentScreen:z,setModalData:_,data:n}=ze(),T=Pe(),{t:I}=ke(),{getAuthFlow:m,walletConnectionStatus:e,closePrivyModal:P,initLoginWithWallet:G,loginWithWallet:Ae,updateWallets:Ie,createAnalyticsEvent:Oe}=Xe(),{walletConnectors:X}=V(),[F,We]=i.useState(0),{user:d}=V(),Le=Je(),[Me]=i.useState((d==null?void 0:d.linkedAccounts.length)||0),[Z,Ue]=i.useState(""),[xe,Ne]=i.useState(""),[De,H]=i.useState(!1),{hasTabbedAway:je}=(function(){let[t,a]=i.useState(!1),r=i.useCallback((()=>{document.hidden&&a(!0)}),[]);return i.useEffect((()=>(document.addEventListener("visibilitychange",r),()=>document.removeEventListener("visibilitychange",r))),[r]),{hasTabbedAway:t,reset:()=>a(!1)}})(),{enabled:Fe,token:Y}=Ke(),f=Qe(((ae=e==null?void 0:e.connector)==null?void 0:ae.walletClientType)||"unknown"),O=R.isMobile&&((oe=e==null?void 0:e.connector)==null?void 0:oe.connectorType)==="wallet_connect_v2"||R.isMobile&&((ie=e==null?void 0:e.connector)==null?void 0:ie.connectorType)==="coinbase_wallet"||R.isMobile&&((le=e==null?void 0:e.connector)==null?void 0:le.connectorType)==="base_account"||R.isMobile&&((re=e==null?void 0:e.connector)==null?void 0:re.connectorType)==="injected"&&((se=e==null?void 0:e.connector)==null?void 0:se.walletClientType)==="phantom"||R.isMobile&&((ce=e==null?void 0:e.connector)==null?void 0:ce.connectorType)==="solana_adapter"&&e.connector.walletClientType==="mobile_wallet_adapter",w=(e==null?void 0:e.status)==="connected",ee=(e==null?void 0:e.status)==="switching_to_supported_chain";i.useEffect((()=>{var r,p,W,L,M,U;let t=m(),a=t instanceof Te||t instanceof Ee?t:void 0;w&&((r=e.connector)==null?void 0:r.chainType)==="solana"&&((p=e.connector)==null?void 0:p.walletClientType)==="phantom"&&Le(Ve)&&((W=n==null?void 0:n.login)==null?void 0:W.isSigningInWithLedgerSolana)===void 0?u("ConnectLedgerScreen",!1):(w&&!a&&(!Fe||Y||x?G(e.connectedWallet,Y,(L=n==null?void 0:n.login)==null?void 0:L.disableSignup,(M=n==null?void 0:n.login)!=null&&M.isSigningInWithLedgerSolana?"transaction":"plain").then((()=>{H(!0)})):(_({captchaModalData:{callback:b=>{var h,C;return G(e.connectedWallet,b,(h=n==null?void 0:n.login)==null?void 0:h.disableSignup,(C=n==null?void 0:n.login)!=null&&C.isSigningInWithLedgerSolana?"transaction":"plain").then((()=>{H(!0)}))},userIntentRequired:!1,onSuccessNavigateTo:"ConnectionStatusScreen",onErrorNavigateTo:"ErrorScreen"}}),u("CaptchaScreen",!1))),a instanceof Ee&&((U=n==null?void 0:n.login)!=null&&U.isSigningInWithLedgerSolana)&&(a.messageType="transaction"),a&&O&&w&&!a.preparedMessage?a.buildMessage():a&&!O&&w&&(l||(async()=>{var b,h;c(!0),A(void 0);try{((b=e==null?void 0:e.connector)==null?void 0:b.connectorType)==="wallet_connect_v2"&&((h=e==null?void 0:e.connector)==null?void 0:h.walletClientType)==="metamask"&&await $e(2500),await J()}catch(C){console.warn("Auto-prompted signature failed",C)}finally{c(!1)}})()))}),[F,w,De]),i.useEffect((()=>{if(d&&s){let t=_e-500;if(T!=null&&T.legal.requireUsersAcceptTerms&&!d.hasAcceptedTerms){let r=setTimeout((()=>{u("AffirmativeConsentScreen")}),t);return()=>clearTimeout(r)}if(ot(d,T.embeddedWallets)){let r=setTimeout((()=>{_({createWallet:{onSuccess:()=>{},onFailure:p=>{console.error(p),Oe({eventName:"embedded_wallet_creation_failure_logout",payload:{error:p,screen:"ConnectionStatusScreen"}}),N()},callAuthOnSuccessOnClose:!0}}),u("EmbeddedWalletOnAccountCreateScreen")}),t);return()=>clearTimeout(r)}Ie();let a=setTimeout((()=>P({shouldCallAuthOnSuccess:!0,isSuccess:!0})),_e);return()=>clearTimeout(a)}}),[d,s]);let te=t=>{var a,r,p,W,L,M,U,b,h,C,he,ye,be,Ce;if((t==null?void 0:t.privyErrorCode)!==k.ALLOWLIST_REJECTED){if((t==null?void 0:t.privyErrorCode)===k.USER_LIMIT_REACHED)return console.error(new et(t).toString()),void u("UserLimitReachedScreen");if((t==null?void 0:t.privyErrorCode)!==k.USER_DOES_NOT_EXIST)return(t==null?void 0:t.privyErrorCode)===k.ACCOUNT_TRANSFER_REQUIRED&&((r=(a=t.data)==null?void 0:a.data)!=null&&r.nonce)?(_({accountTransfer:{nonce:(W=(p=t.data)==null?void 0:p.data)==null?void 0:W.nonce,account:(L=m())==null?void 0:L.meta.address,displayName:(b=(U=(M=t.data)==null?void 0:M.data)==null?void 0:U.account)==null?void 0:b.displayName,externalWalletMetadata:{walletClientType:(h=m())==null?void 0:h.meta.walletClientType,chainId:(C=m())==null?void 0:C.meta.chainId,connectorType:(he=m())==null?void 0:he.meta.connectorType},linkMethod:m()instanceof Te?"siwe":"siws",embeddedWalletAddress:(Ce=(be=(ye=t.data)==null?void 0:ye.data)==null?void 0:be.otherUser)==null?void 0:Ce.embeddedWalletAddress}}),void u("LinkConflictScreen")):void A(lt(t));u("AccountNotFoundScreen")}else u("AllowlistRejectionScreen")};async function J(){try{await Ae(),E(!0)}catch(t){te(t)}finally{c(!1)}}i.useEffect((()=>{e!=null&&e.connectError&&te(e==null?void 0:e.connectError)}),[e]),((t,a)=>{let r=i.useRef((()=>{}));i.useEffect((()=>{r.current=t})),i.useEffect((()=>{if(a!==null){let p=setInterval((()=>r.current()),a||0);return()=>clearInterval(p)}}),[a])})((()=>{let t=B==="wallet_connect_v2"&&(e==null?void 0:e.connector)instanceof $?e.connector.redirectUri:void 0;t&&Ue(t);let a=B==="wallet_connect_v2"&&(e==null?void 0:e.connector)instanceof $?e.connector.fallbackUniversalRedirectUri:void 0;a&&Ne(a)}),(e==null?void 0:e.connector)instanceof $&&!Z?500:null);let B=((de=e==null?void 0:e.connector)==null?void 0:de.connectorType)||"injected",K=((ue=e==null?void 0:e.connector)==null?void 0:ue.walletClientType)||"unknown",Q=((ge=f==null?void 0:f.metadata)==null?void 0:ge.shortName)||(f==null?void 0:f.name)||((Se=e==null?void 0:e.connector)==null?void 0:Se.walletBranding.name)||"Browser Extension",Be=((pe=f==null?void 0:f.image_url)==null?void 0:pe.md)||((fe=e==null?void 0:e.connector)==null?void 0:fe.walletBranding.icon)||(t=>y.jsx(Ge,{...t})),ne=Q==="Browser Extension"?Q.toLowerCase():Q;o=s?I("connectionStatus.successfullyConnected",{walletName:ne}):S?I("connectionStatus.errorTitle",{errorMessage:S.message}):ee?"Switching networks":w?l&&O?"Signing":"Sign to verify":`Waiting for ${ne}`;let g=I("connectionStatus.checkOtherWindows");s?g=Me===((d==null?void 0:d.linkedAccounts.length)||0)?"Wallet was already linked.":"You're good to go!":F>=2&&S?g="Unable to connect wallet":S?g=S.detail:ee?g="Switch your wallet to the requested network.":w&&O?g="Sign the message in your wallet to verify it belongs to you.":K==="metamask"&&R.isMobile?g="Click continue to open and connect MetaMask.":K==="metamask"?g="For the best experience, connect only one wallet at a time.":B==="wallet_connect"?g="Open your mobile wallet app to continue":B==="coinbase_wallet"?Ze()||(g=ve(d)?"Continue with the Coinbase app. Not the right wallet? Reset your connection below.":"Confirm in the Coinbase app/popup to continue."):(we=n==null?void 0:n.login)!=null&&we.isSigningInWithLedgerSolana&&(g="Ledger requires a transaction to verify your identity. You'll sign a transaction that performs no onchain action.");let q=(me=X==null?void 0:X.walletConnectors)==null?void 0:me.find((t=>t.walletClientType==="coinbase_wallet")),qe=K==="coinbase_wallet"&&(ve(d)||S===v.ERROR_USER_EXISTS);return y.jsx(rt,{walletLogo:Be,title:o,subtitle:g,signSuccess:s,errorMessage:S,connectSuccess:w,separateConnectAndSign:O,signing:l,walletConnectRedirectUri:Z,walletConnectFallbackUniversalUri:xe,hasTabbedAway:je,showCoinbaseWalletResetCta:qe,numRetries:F,onBack:j&&z!==j?D:void 0,onSign:()=>{c(!0),J()},onRetry:()=>{We(F+1),A(void 0),w?(c(!0),J()):e==null||e.connectRetry()},onCoinbaseReset:()=>{q&&(q==null||q.disconnect())},onDifferentWallet:D})}};let st=at.p`
  text-align: center;
  color: var(--privy-color-foreground-2);
  font-size: 14px;
  line-height: 22px;
  margin: 16px 0;
`;export{mt as ConnectionStatusScreen,rt as ConnectionStatusView,mt as default,lt as getErrorDetails};
