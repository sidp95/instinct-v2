'use client'
import { __awaiter } from '../../../../../../_virtual/_tslib.js';
import { jsx, jsxs, Fragment } from 'react/jsx-runtime';
import { useState, useRef, useCallback, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { IconButton } from '../../../../components/IconButton/IconButton.js';
import { ModalHeader } from '../../../../components/ModalHeader/ModalHeader.js';
import { Typography } from '../../../../components/Typography/Typography.js';
import { TypographyButton } from '../../../../components/TypographyButton/TypographyButton.js';
import { useViewContext } from '../../../../context/ViewContext/ViewContext.js';
import { ReactComponent as SvgChevronLeft } from '../../../../shared/assets/chevron-left.js';
import { ReactComponent as SvgExclamation } from '../../../../shared/assets/exclamation.js';
import '@dynamic-labs/iconic';
import { useWalletBackup, useBackupWallets } from '../../../../utils/hooks/useWalletBackup/useWalletBackup.js';
import { CloudBackupProvider } from '../../../../utils/hooks/useWalletBackup/types.js';
import { CLOUD_PROVIDER_CONFIGS } from '../../../../utils/hooks/useWalletBackup/cloudProviders.js';

const WaasBackupProgressView = ({ provider = CloudBackupProvider.GoogleDrive, }) => {
    const { goBack, pushView } = useViewContext();
    const { t } = useTranslation();
    const providerConfig = CLOUD_PROVIDER_CONFIGS[provider];
    const { getWalletsToBackup, showICloudAuth, checkICloudAuth, hideICloudAuth, } = useWalletBackup();
    const [displayContainer, setDisplayContainer] = useState(null);
    const [authState, setAuthState] = useState('pending');
    const [authError, setAuthError] = useState(null);
    const hasInitializedRef = useRef(false);
    const handleComplete = useCallback(() => {
        pushView('waas-backup-download-view');
    }, [pushView]);
    const handleBackClick = useCallback(() => goBack(), [goBack]);
    // Move useBackupWallets before the init effect so `start` is available
    const { currentIndex, hasError, isComplete, retry, totalWallets, start } = useBackupWallets(handleComplete, provider, displayContainer || undefined);
    // Callback ref replaces useRef + useEffect pattern
    const containerRefCallback = useCallback((node) => {
        if (providerConfig.requiresIframe && node) {
            setDisplayContainer(node);
        }
    }, [providerConfig.requiresIframe]);
    // Initialize backup: start immediately for non-iframe providers, or wait for iCloud auth
    useEffect(() => {
        if (hasInitializedRef.current)
            return;
        // For non-iframe providers (Google Drive), start immediately
        if (!providerConfig.requiresIframe) {
            hasInitializedRef.current = true;
            start();
            return;
        }
        // For iframe providers (iCloud), wait for container
        if (!displayContainer)
            return;
        if (authState !== 'pending')
            return;
        const wallets = getWalletsToBackup();
        if (wallets.length === 0)
            return;
        hasInitializedRef.current = true;
        const initAuth = () => __awaiter(void 0, void 0, void 0, function* () {
            const success = yield showICloudAuth(displayContainer, wallets[0].chain);
            if (success) {
                // Check auth status BEFORE setting state to avoid UI flash
                const isAlreadyAuthed = yield checkICloudAuth(wallets[0].chain);
                if (isAlreadyAuthed) {
                    setAuthState('authenticated');
                    start();
                }
                else {
                    // Only show 'shown' state if user needs to authenticate
                    setAuthState('shown');
                }
            }
            else {
                setAuthState('failed');
                setAuthError(t('dyn_waas.backup.error'));
            }
        });
        initAuth();
    }, [
        providerConfig.requiresIframe,
        displayContainer,
        authState,
        showICloudAuth,
        checkICloudAuth,
        getWalletsToBackup,
        t,
        start,
    ]);
    // Cleanup: hide iCloud auth on unmount
    useEffect(() => () => {
        if (providerConfig.requiresIframe && displayContainer) {
            const wallets = getWalletsToBackup();
            if (wallets.length > 0) {
                hideICloudAuth(wallets[0].chain);
            }
        }
    }, [
        providerConfig.requiresIframe,
        displayContainer,
        hideICloudAuth,
        getWalletsToBackup,
    ]);
    const handleStartiCloudBackup = useCallback(() => __awaiter(void 0, void 0, void 0, function* () {
        if (!displayContainer) {
            setAuthError(t('dyn_waas.backup.error'));
            return;
        }
        const wallets = getWalletsToBackup();
        if (wallets.length === 0)
            return;
        const isAuthed = yield checkICloudAuth(wallets[0].chain);
        if (!isAuthed) {
            setAuthState('failed');
            setAuthError(t('dyn_waas.backup.error_title'));
            return;
        }
        setAuthState('authenticated');
        start();
    }), [displayContainer, checkICloudAuth, getWalletsToBackup, start, t]);
    const handleRetry = useCallback(() => {
        if (providerConfig.requiresIframe) {
            hasInitializedRef.current = false;
            setAuthState('pending');
            setAuthError(null);
        }
        else {
            retry();
        }
    }, [providerConfig.requiresIframe, retry]);
    const getProgressText = () => {
        if (isComplete) {
            return t('dyn_waas.backup.progress_complete');
        }
        if (totalWallets === 0) {
            return t('dyn_waas.backup.progress_initializing');
        }
        return t('dyn_waas.backup.progress_title', {
            current: currentIndex,
            total: totalWallets,
        });
    };
    const renderProgressContent = () => {
        if (hasError || authState === 'failed') {
            return (jsxs(Fragment, { children: [jsx(Typography, { variant: 'body_normal', color: 'primary', copykey: 'dyn_waas.backup.error_title', className: 'waas-backup-view__progress-title', children: authError || t('dyn_waas.backup.error_title') }), jsx("div", { className: 'waas-backup-view__progress-actions', children: jsx(TypographyButton, { dataTestId: 'retry-backup-button', onClick: handleRetry, copykey: 'dyn_waas.backup.error_try_again', buttonVariant: 'brand-primary', typographyProps: {
                                color: 'inherit',
                            }, expanded: true, children: t('dyn_waas.backup.error_try_again') }) })] }));
        }
        if (providerConfig.requiresIframe &&
            authState === 'shown' &&
            totalWallets === 0 &&
            !isComplete) {
            return (jsxs(Fragment, { children: [jsx(Typography, { variant: 'title', color: 'primary', copykey: 'dyn_waas.backup.icloud_ready_title', className: 'waas-backup-view__progress-title', children: t('dyn_waas.backup.icloud_ready_title') }), jsx(Typography, { variant: 'body_normal', color: 'secondary', copykey: 'dyn_waas.backup.icloud_ready_subtitle', className: 'waas-backup-view__progress-subtitle', children: t('dyn_waas.backup.icloud_ready_subtitle') }), jsx("div", { className: 'waas-backup-view__progress-actions', children: jsx(TypographyButton, { dataTestId: 'continue-icloud-backup-button', onClick: handleStartiCloudBackup, copykey: 'dyn_waas.backup.continue_backup', buttonVariant: 'brand-primary', typographyProps: {
                                color: 'inherit',
                            }, disabled: !displayContainer, expanded: true, children: t('dyn_waas.backup.continue_backup') }) })] }));
        }
        return (jsxs(Fragment, { children: [jsx(Typography, { variant: 'title', color: 'primary', copykey: 'dyn_waas.backup.progress_title', className: 'waas-backup-view__progress-title', children: getProgressText() }), jsx(Typography, { variant: 'body_normal', color: 'secondary', copykey: 'dyn_waas.backup.progress_subtitle', className: 'waas-backup-view__progress-subtitle', children: t('dyn_waas.backup.progress_subtitle') })] }));
    };
    const backButton = hasError ? (jsx(IconButton, { type: 'button', onClick: handleBackClick, "data-testid": 'back-button', children: jsx(SvgChevronLeft, {}) })) : undefined;
    return (jsxs(Fragment, { children: [jsx(ModalHeader, { leading: backButton, children: jsx(Typography, { variant: 'title', color: 'primary', copykey: 'dyn_waas.backup.cloud_backup_header', children: t('dyn_waas.backup.cloud_backup_header') }) }), jsxs("div", { className: 'waas-backup-view', children: [jsxs("div", { className: 'waas-backup-view__progress', children: [jsxs("div", { className: `waas-backup-view__progress-icon ${hasError ? 'waas-backup-view__progress-icon--error' : ''}`, children: [providerConfig.icon, hasError && (jsx("div", { className: 'waas-backup-view__progress-error-badge', children: jsx(SvgExclamation, {}) }))] }), renderProgressContent()] }), providerConfig.requiresIframe && (jsx("div", { ref: containerRefCallback, className: 'waas-backup-view__icloud-container' }))] })] }));
};

export { WaasBackupProgressView };
