'use client'
'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var _tslib = require('../../../../../../_virtual/_tslib.cjs');
var jsxRuntime = require('react/jsx-runtime');
var React = require('react');
var reactI18next = require('react-i18next');
var IconButton = require('../../../../components/IconButton/IconButton.cjs');
var ModalHeader = require('../../../../components/ModalHeader/ModalHeader.cjs');
var Typography = require('../../../../components/Typography/Typography.cjs');
var TypographyButton = require('../../../../components/TypographyButton/TypographyButton.cjs');
var ViewContext = require('../../../../context/ViewContext/ViewContext.cjs');
var chevronLeft = require('../../../../shared/assets/chevron-left.cjs');
var exclamation = require('../../../../shared/assets/exclamation.cjs');
require('@dynamic-labs/iconic');
var useWalletBackup = require('../../../../utils/hooks/useWalletBackup/useWalletBackup.cjs');
var types = require('../../../../utils/hooks/useWalletBackup/types.cjs');
var cloudProviders = require('../../../../utils/hooks/useWalletBackup/cloudProviders.cjs');

const WaasBackupProgressView = ({ provider = types.CloudBackupProvider.GoogleDrive, }) => {
    const { goBack, pushView } = ViewContext.useViewContext();
    const { t } = reactI18next.useTranslation();
    const providerConfig = cloudProviders.CLOUD_PROVIDER_CONFIGS[provider];
    const { getWalletsToBackup, showICloudAuth, checkICloudAuth, hideICloudAuth, } = useWalletBackup.useWalletBackup();
    const [displayContainer, setDisplayContainer] = React.useState(null);
    const [authState, setAuthState] = React.useState('pending');
    const [authError, setAuthError] = React.useState(null);
    const hasInitializedRef = React.useRef(false);
    const handleComplete = React.useCallback(() => {
        pushView('waas-backup-download-view');
    }, [pushView]);
    const handleBackClick = React.useCallback(() => goBack(), [goBack]);
    // Move useBackupWallets before the init effect so `start` is available
    const { currentIndex, hasError, isComplete, retry, totalWallets, start } = useWalletBackup.useBackupWallets(handleComplete, provider, displayContainer || undefined);
    // Callback ref replaces useRef + useEffect pattern
    const containerRefCallback = React.useCallback((node) => {
        if (providerConfig.requiresIframe && node) {
            setDisplayContainer(node);
        }
    }, [providerConfig.requiresIframe]);
    // Initialize backup: start immediately for non-iframe providers, or wait for iCloud auth
    React.useEffect(() => {
        if (hasInitializedRef.current)
            return;
        // For non-iframe providers (Google Drive), start immediately
        if (!providerConfig.requiresIframe) {
            hasInitializedRef.current = true;
            start();
            return;
        }
        // For iframe providers (iCloud), wait for container
        if (!displayContainer)
            return;
        if (authState !== 'pending')
            return;
        const wallets = getWalletsToBackup();
        if (wallets.length === 0)
            return;
        hasInitializedRef.current = true;
        const initAuth = () => _tslib.__awaiter(void 0, void 0, void 0, function* () {
            const success = yield showICloudAuth(displayContainer, wallets[0].chain);
            if (success) {
                // Check auth status BEFORE setting state to avoid UI flash
                const isAlreadyAuthed = yield checkICloudAuth(wallets[0].chain);
                if (isAlreadyAuthed) {
                    setAuthState('authenticated');
                    start();
                }
                else {
                    // Only show 'shown' state if user needs to authenticate
                    setAuthState('shown');
                }
            }
            else {
                setAuthState('failed');
                setAuthError(t('dyn_waas.backup.error'));
            }
        });
        initAuth();
    }, [
        providerConfig.requiresIframe,
        displayContainer,
        authState,
        showICloudAuth,
        checkICloudAuth,
        getWalletsToBackup,
        t,
        start,
    ]);
    // Cleanup: hide iCloud auth on unmount
    React.useEffect(() => () => {
        if (providerConfig.requiresIframe && displayContainer) {
            const wallets = getWalletsToBackup();
            if (wallets.length > 0) {
                hideICloudAuth(wallets[0].chain);
            }
        }
    }, [
        providerConfig.requiresIframe,
        displayContainer,
        hideICloudAuth,
        getWalletsToBackup,
    ]);
    const handleStartiCloudBackup = React.useCallback(() => _tslib.__awaiter(void 0, void 0, void 0, function* () {
        if (!displayContainer) {
            setAuthError(t('dyn_waas.backup.error'));
            return;
        }
        const wallets = getWalletsToBackup();
        if (wallets.length === 0)
            return;
        const isAuthed = yield checkICloudAuth(wallets[0].chain);
        if (!isAuthed) {
            setAuthState('failed');
            setAuthError(t('dyn_waas.backup.error_title'));
            return;
        }
        setAuthState('authenticated');
        start();
    }), [displayContainer, checkICloudAuth, getWalletsToBackup, start, t]);
    const handleRetry = React.useCallback(() => {
        if (providerConfig.requiresIframe) {
            hasInitializedRef.current = false;
            setAuthState('pending');
            setAuthError(null);
        }
        else {
            retry();
        }
    }, [providerConfig.requiresIframe, retry]);
    const getProgressText = () => {
        if (isComplete) {
            return t('dyn_waas.backup.progress_complete');
        }
        if (totalWallets === 0) {
            return t('dyn_waas.backup.progress_initializing');
        }
        return t('dyn_waas.backup.progress_title', {
            current: currentIndex,
            total: totalWallets,
        });
    };
    const renderProgressContent = () => {
        if (hasError || authState === 'failed') {
            return (jsxRuntime.jsxs(jsxRuntime.Fragment, { children: [jsxRuntime.jsx(Typography.Typography, { variant: 'body_normal', color: 'primary', copykey: 'dyn_waas.backup.error_title', className: 'waas-backup-view__progress-title', children: authError || t('dyn_waas.backup.error_title') }), jsxRuntime.jsx("div", { className: 'waas-backup-view__progress-actions', children: jsxRuntime.jsx(TypographyButton.TypographyButton, { dataTestId: 'retry-backup-button', onClick: handleRetry, copykey: 'dyn_waas.backup.error_try_again', buttonVariant: 'brand-primary', typographyProps: {
                                color: 'inherit',
                            }, expanded: true, children: t('dyn_waas.backup.error_try_again') }) })] }));
        }
        if (providerConfig.requiresIframe &&
            authState === 'shown' &&
            totalWallets === 0 &&
            !isComplete) {
            return (jsxRuntime.jsxs(jsxRuntime.Fragment, { children: [jsxRuntime.jsx(Typography.Typography, { variant: 'title', color: 'primary', copykey: 'dyn_waas.backup.icloud_ready_title', className: 'waas-backup-view__progress-title', children: t('dyn_waas.backup.icloud_ready_title') }), jsxRuntime.jsx(Typography.Typography, { variant: 'body_normal', color: 'secondary', copykey: 'dyn_waas.backup.icloud_ready_subtitle', className: 'waas-backup-view__progress-subtitle', children: t('dyn_waas.backup.icloud_ready_subtitle') }), jsxRuntime.jsx("div", { className: 'waas-backup-view__progress-actions', children: jsxRuntime.jsx(TypographyButton.TypographyButton, { dataTestId: 'continue-icloud-backup-button', onClick: handleStartiCloudBackup, copykey: 'dyn_waas.backup.continue_backup', buttonVariant: 'brand-primary', typographyProps: {
                                color: 'inherit',
                            }, disabled: !displayContainer, expanded: true, children: t('dyn_waas.backup.continue_backup') }) })] }));
        }
        return (jsxRuntime.jsxs(jsxRuntime.Fragment, { children: [jsxRuntime.jsx(Typography.Typography, { variant: 'title', color: 'primary', copykey: 'dyn_waas.backup.progress_title', className: 'waas-backup-view__progress-title', children: getProgressText() }), jsxRuntime.jsx(Typography.Typography, { variant: 'body_normal', color: 'secondary', copykey: 'dyn_waas.backup.progress_subtitle', className: 'waas-backup-view__progress-subtitle', children: t('dyn_waas.backup.progress_subtitle') })] }));
    };
    const backButton = hasError ? (jsxRuntime.jsx(IconButton.IconButton, { type: 'button', onClick: handleBackClick, "data-testid": 'back-button', children: jsxRuntime.jsx(chevronLeft.ReactComponent, {}) })) : undefined;
    return (jsxRuntime.jsxs(jsxRuntime.Fragment, { children: [jsxRuntime.jsx(ModalHeader.ModalHeader, { leading: backButton, children: jsxRuntime.jsx(Typography.Typography, { variant: 'title', color: 'primary', copykey: 'dyn_waas.backup.cloud_backup_header', children: t('dyn_waas.backup.cloud_backup_header') }) }), jsxRuntime.jsxs("div", { className: 'waas-backup-view', children: [jsxRuntime.jsxs("div", { className: 'waas-backup-view__progress', children: [jsxRuntime.jsxs("div", { className: `waas-backup-view__progress-icon ${hasError ? 'waas-backup-view__progress-icon--error' : ''}`, children: [providerConfig.icon, hasError && (jsxRuntime.jsx("div", { className: 'waas-backup-view__progress-error-badge', children: jsxRuntime.jsx(exclamation.ReactComponent, {}) }))] }), renderProgressContent()] }), providerConfig.requiresIframe && (jsxRuntime.jsx("div", { ref: containerRefCallback, className: 'waas-backup-view__icloud-container' }))] })] }));
};

exports.WaasBackupProgressView = WaasBackupProgressView;
