"use strict";var e=require("react/jsx-runtime"),r=require("react"),t=require("./ModalHeader-HFJct04e.js"),o=require("./ScreenHeader-CgYJ5Fmg.js"),a=require("./context-B8VkgLLk.js"),i=require("./index-B-V647xG.js"),l=require("./internal-context-NWsAL807.js"),n=require("./get-is-unified-wallet--p0rdEtP.js"),c=require("./paths-DizMb-lU.js"),s=require("./useWallets-DEyFRWD0.js"),d=require("./events-context-Di6--rDg.js"),u=require("./use-create-wallet-without-fallback-B3AnOM0l.js"),v=require("./styles-CQnB5gHS.js");async function y({url:e,popup:r,provider:t}){return r.location=e,new Promise(((e,t)=>{function o(){r?.close(),window.removeEventListener("message",a)}function a(r){r.data&&("PRIVY_OAUTH_RESPONSE"===r.data.type&&r.data.stateCode&&r.data.authorizationCode&&(e(r.data),o()),"https://cdn.apple-cloudkit.com"===r.origin&&r.data.ckSession&&(e({type:"PRIVY_OAUTH_RESPONSE",ckWebAuthToken:r.data.ckSession}),o()),"PRIVY_OAUTH_ERROR"===r.data.type&&(t(r.data.error),o()))}window.addEventListener("message",a)}))}async function h({api:e,provider:r,stateCode:t,codeVerifier:o,authorizationCode:a}){if(!a||!t)throw new l.PrivyClientError("[OAuth AuthFlow] Authorization and state codes code must be set prior to calling authenicate.");if("undefined"===a)throw new l.PrivyClientError("User denied confirmation during OAuth flow");try{return(await e.post(c.recoveryOAuthAuthenticatePath,{authorization_code:a,state_code:t,code_verifier:o,provider:r})).access_token}catch(e){let r=l.formatApiError(e);if(r.privyErrorCode)throw new l.PrivyClientError(r.message||"Invalid code during OAuth flow.",void 0,r.privyErrorCode);if("User denied confirmation during OAuth flow"===r.message)throw new l.PrivyClientError("Invalid code during oauth flow.",void 0,l.PrivyErrorCode.OAUTH_USER_DENIED);throw new l.PrivyClientError("Invalid code during OAuth flow.",void 0,l.PrivyErrorCode.UNKNOWN_AUTH_ERROR)}}async function p({api:e,provider:r}){let t=i.createCodeVerifier(),o=i.createStateCode(),a=await i.deriveCodeChallengeFromCodeVerifier(t);try{return"icloud"===r?{url:(await e.post(c.recoveryOAuthInitICloudPath,{client_type:"web"})).url}:{url:(await e.post(c.recoveryOAuthInitPath,{redirect_to:window.location.href,code_challenge:a,state_code:o})).url,codeVerifier:t,stateCode:o,provider:r}}catch(e){throw l.formatApiError(e)}}require("styled-components"),require("./useActiveWallet-Wp8zv7qb.js"),require("zustand"),require("react-device-detect"),require("./prepareFundingModalData-BADfvap9.js"),require("@privy-io/js-sdk-core"),require("eventemitter3"),require("viem"),require("viem/utils"),require("./getPublicClient-CGlodIp_.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("tinycolor2"),require("uuid"),require("jose"),require("@coinbase/wallet-sdk"),require("@privy-io/ethereum"),require("mipd"),require("@privy-io/popup"),require("./usePrivy-BM1sYNel.js"),require("@scure/base"),require("@headlessui/react"),require("@walletconnect/ethereum-provider"),require("@privy-io/urls"),require("ofetch"),require("js-cookie"),require("./frame-B14fp9oC.js"),require("@privy-io/routes"),require("x402/client"),require("@privy-io/api-base"),require("viem/accounts"),require("./use-sign-with-user-signer-BcAsQTGF.js"),require("./getEmbeddedConnectedWallet-6TsVZJkD.js");let w={"google-drive":{name:"Google Drive",component:v.GoogleDrive},icloud:{name:"iCloud",component:v.AppleICloud}};const E={component:()=>{let{logout:c}=n.usePrivyContext(),{navigate:E,setModalData:m,data:C}=n.usePrivyModal(),{closePrivyModal:f,createAnalyticsEvent:A}=l.usePrivyInternal(),{execute:_}=(()=>{let{client:e,walletProxy:r,refreshSessionAndUser:t}=l.usePrivyInternal(),{data:o}=n.usePrivyModal(),{user:a}=n.usePrivyContext(),i=d.useEmitPrivyEvent(),{create:c}=u.useCreateWalletWithoutFallback();return{execute:async({provider:d,action:u,popup:v,shouldCreateEth:w,shouldCreateSol:E})=>{let m,C;if(!e)throw new l.PrivyClientError("Missing client");function f(r){if(!r&&e)throw e.createAnalyticsEvent({eventName:"recovery_oauth_error",payload:{error:"Unable to open recovery OAuth popup",provider:d}}),new l.PrivyClientError("Recovery OAuth failed")}switch(d){case"google-drive":{let r,t,{url:o,codeVerifier:a,stateCode:i}=await p({api:e.api,provider:d});f(o);try{let a=await y({url:o,popup:v,provider:d});if(r=a.stateCode,t=a.authorizationCode,r!==i)throw e.createAnalyticsEvent({eventName:"possible_phishing_attempt",payload:{provider:d,storedStateCode:i??"",returnedStateCode:r??""}}),new l.PrivyClientError("Unexpected auth flow. This may be a phishing attempt.",void 0,l.PrivyErrorCode.OAUTH_UNEXPECTED)}catch(r){throw e.createAnalyticsEvent({eventName:"recovery_oauth_error",payload:{error:r.toString(),provider:d}}),new l.PrivyClientError("Recovery OAuth failed")}[m,C]=await Promise.all([e.getAccessToken(),h({api:e.api,provider:d,codeVerifier:a,stateCode:r,authorizationCode:t})]);break}case"icloud":{let{url:r}=await p({api:e.api,provider:d});f(r);let{ckWebAuthToken:t}=await y({url:r,popup:v,provider:d});C=t,m=await e.getAccessToken()}}if(!r)throw new l.PrivyClientError("Cannot connect to wallet proxy");if(!m)throw new l.PrivyClientError("Unable to authorize user");switch(u){case"recover":{let t=o?.recoverWallet?.entropyId,a=o?.recoverWallet?.entropyIdVerifier;if(!t||!a)throw new l.PrivyClientError("Recovery OAuth failed");e.createAnalyticsEvent({eventName:"embedded_wallet_recovery_started",payload:{walletAddress:t,recoveryMethod:d}}),await r.recover({accessToken:m,entropyId:t,entropyIdVerifier:a,recoveryAccessToken:C}),e.createAnalyticsEvent({eventName:"embedded_wallet_recovery_completed",payload:{walletAddress:t,recoveryMethod:d}});break}case"create-wallet":{let r;if(e.createAnalyticsEvent({eventName:"embedded_wallet_creation_started"}),w&&E)r=await c({recoveryMethod:d,recoveryAccessToken:C,chainType:"ethereum",walletIndex:0,latestUser:a}),r=await c({chainType:"solana",walletIndex:0,latestUser:r.user});else if(E)r=await c({recoveryMethod:d,recoveryAccessToken:C,chainType:"solana",walletIndex:0,latestUser:a});else{if(!w)throw Error("Invalid args to create wallet");r=await c({recoveryMethod:d,recoveryAccessToken:C,chainType:"ethereum",walletIndex:0,latestUser:a})}if(!r)throw i("createWallet","onError",l.PrivyErrorCode.UNKNOWN_EMBEDDED_WALLET_ERROR),Error("Failed to create wallet");e.createAnalyticsEvent({eventName:"embedded_wallet_creation_completed",payload:{walletAddress:r.account.address}}),i("createWallet","onSuccess",{wallet:r.account});break}case"set-recovery":{let o=n.getPrivyPrimaryWallet(a);if(!o)throw i("setWalletRecovery","onError",l.PrivyErrorCode.EMBEDDED_WALLET_NOT_FOUND),Error("Embedded wallet not found");e.createAnalyticsEvent({eventName:"embedded_wallet_set_recovery_started",payload:{walletAddress:o.address,existingRecoveryMethod:o.recoveryMethod,targetRecoveryMethod:d}});let{entropyId:c,entropyIdVerifier:u}=s.getEntropyDetailsForUser(a);await r.setRecovery({accessToken:m,entropyId:c,entropyIdVerifier:u,recoveryMethod:d,recoveryAccessToken:C});let v=n.getPrivyPrimaryWallet(await t());if(!v)throw i("createWallet","onError",l.PrivyErrorCode.UNKNOWN_EMBEDDED_WALLET_ERROR),Error("Failed to set recovery on wallet");e.createAnalyticsEvent({eventName:"embedded_wallet_set_recovery_completed",payload:{walletAddress:o.address,existingRecoveryMethod:o.recoveryMethod,targetRecoveryMethod:d}}),i("setWalletRecovery","onSuccess",{method:d,wallet:v});break}default:throw new l.PrivyClientError("Unsupported recovery action")}}}})(),[g,P]=r.useState(!1),{provider:q,action:b,isInAccountCreateFlow:R,shouldCreateEth:S,shouldCreateSol:x}=C?.recoveryOAuthStatus,[O,k]=r.useState(void 0),[T,j]=r.useState("create-wallet"===b);if("user-passcode"===q)throw Error("RecoveryOAuthScreen should never be called with a wallet that specifies recoveryMethod: `user-passcode`");let I=w[q].name,N=w[q].component,U=C?.recoverWallet?.onCompleteNavigateTo,M=new i.RunEffectOnce((async(e="create-wallet")=>(j(!0),new Promise(((r,t)=>{setTimeout((async()=>{try{let t=window.open();await _({provider:q,action:e,popup:t,shouldCreateEth:S,shouldCreateSol:x}),P(!0),r()}catch(r){k({message:`${"recover"===e?"Recovery":"Back up"} with ${I} unsuccessful`,detail:"recover"===b?`Please verify that you are selecting the ${I} account associated with your backup.`:"",retryable:!0}),t()}}),0)})))));r.useEffect((()=>{"recover"!==b&&M.execute(R?"create-wallet":"set-recovery")}),[]),r.useEffect((()=>{if(!g)return;let e=setTimeout((()=>{R?(m({createWallet:{onSuccess:()=>{},onFailure:e=>{A({eventName:"embedded_wallet_creation_failure_logout",payload:{error:e,screen:"RecoveryOAuthScreen"}}),c()},callAuthOnSuccessOnClose:!0,shouldCreateEth:!1,shouldCreateSol:!1}}),E("EmbeddedWalletCreatedScreen")):f({shouldCallAuthOnSuccess:!1})}),a.DEFAULT_SUCCESS_SCREEN_DURATION_MS);return()=>clearTimeout(e)}),[g]);let W=r.useCallback((async()=>{await M.execute("recover"),U?E(U):P(!0)}),[]),D="google-drive"===q?"Google Drive":"Apple iCloud",F=g&&`Successfully ${"recover"===b?"recovered":"backed up"} with ${D}.`||O&&O.message||`${"recover"===b?"Recovering":"Backing up"} with ${D}...`,V=O?O.detail:"";/*#__PURE__*/return e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(t.ModalHeader,{}),T?/*#__PURE__*/e.jsx(e.Fragment,{children:/*#__PURE__*/e.jsxs(v.RecoveryContainer,{children:[/*#__PURE__*/e.jsx(o.CenteredScreenHeader,{title:F,icon:/*#__PURE__*/e.jsx(N,{style:{width:"38px",height:"38px"}}),description:V}),O&&O?.retryable?/*#__PURE__*/e.jsx(t.PrimaryButton,{onClick:()=>{i.stripUrlOAuthParamsAndRemoveStateCode(),k(void 0),"create-wallet"===b?M.execute("create-wallet"):W()},disabled:!g&&!O?.retryable,children:"Try again"}):null]})}):/*#__PURE__*/e.jsxs(v.RecoveryContainer,{children:[/*#__PURE__*/e.jsx(o.CenteredScreenHeader,{title:"Confirm it's really you",icon:/*#__PURE__*/e.jsx(N,{style:{height:42,width:48}}),description:`To confirm your identity, please log in to ${D} where your account is backed up.`}),/*#__PURE__*/e.jsxs(t.PrimaryButton,{onClick:W,children:["Confirm with ",D]})]}),/*#__PURE__*/e.jsx(t.BlobbyFooter,{})]})}};exports.RecoveryOAuthScreen=E,exports.default=E;
